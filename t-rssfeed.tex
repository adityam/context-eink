%D \module
%D   [     file=t-rssfeed,
%D      version=2012.05.25,
%D        title=\CONTEXT\ User Module,
%D     subtitle=eInk Style File for RSS Feeds,
%D       author=Aditya Mahajan,
%D         date=\currentdate,
%D    copyright=Aditya Mahajan,
%D        email=adityam <at> ieee <dot> org,
%D      license=Simplified BSD License]

\startmodule rssfeed

\unprotect

\usemodule[t][eink]
          [
            \c!alternative=kindle,
            mainfont={Linux Libertine O},
            sansfont={Dejavu Sans},
            monofont={Dejavu Sans Mono},
            \c!size=10pt,
          ]

% Mostly, the typing environment is for code.
% Kindle has a small linewidth, so we use a smaller
% font for typing
\setuptyping
  [
    \c!style={\switchtobodyfont[8pt]},
    \c!color=white,
    \c!before={\starttyping_background},
    \c!after={\stoptyping_background},
    \c!lines=\v!yes,
  ]

\definebackground[typing_background]
                 [
                   \c!background=\c!color,
                   \c!backgroundcolor=black,
                 ]


% Each post is a new chapter
\setuphead[\v!chapter,\v!title]
          [
            \c!alternative=\v!middle,
            \c!style=\ssbfb,
            \c!before={\blank[2*\v!big,\v!force]},
            \c!after={\blank[4*\v!big]},
            \c!number=\v!no,
          ]

\setuphead[\v!section,\v!subject]
          [
            \c!style=\ssbfa,
            \c!before={\blank[\v!big]},
            \c!after={\blank[\v!big]},
            \c!number=\v!no,
          ]

\setuphead[\v!subsection,\v!subsubject]
          [
            \c!style=\ssbf,
            \c!before={\blank[\v!medium]},
            \c!after={\blank[\v!medium]},
            \c!number=\v!no,
          ]

\setuphead[\v!subsubsection,\v!subsubsubject]
          [
            \c!alternative=\v!text,
            \c!style=\ssbf,
            \c!before={\blank},
            \c!after=,
            \c!number=\v!no,
          ]

% Setup for feed titlepage
\setvariables
  [rssfeed]
  [
    title=,
    description=,
    link=,
    set={\setups{rssfeed:titlepage}},
  ]

\startsetups rssfeed:titlepage
  \startinterlude
      \getvariable{rssfeed}{title}
      \blank[2*big]
      \getvariable{rssfeed}{description}
      \vfill
      {\getvariable{rssfeed}{link}}
  \stopinterlude
\stopsetups

% Arxiv sometimes uses an explicit \emph command:
\definehighlight[emph][style=\em]

% Bugfix for figures
\let\normalexternalfigure\externalfigure
\unexpanded\def\externalfigure
    {\dodoubleargument\rssfeed_externalfigure}

\def\rssfeed_externalfigure[#1][#2]%
    % Sometimes the included image is a gif file
    % which completely messes things up. So, we check the format
    % of the image before trying to include it.
    {\ctxlua{thirddata.rssfeed.image_format (\!!bs \locfilename{#1}\!!es)}%
    \doifnot{\rssfeed_format}{GIF}
        {\normalexternalfigure[#1][\c!scale=2000, \c!method=auto, #2]}}

\startluacode
  thirddata = thirddata or {}
  thirddata.rssfeed = {}

  local rssfeed = thirddata.rssfeed
  local sformat,osexec, ioload, setvalue = string.format, os.execute, io.loaddata, context.setvalue

  function rssfeed.image_format(image) 
    osexec(sformat("identify -format \"%%m\" %s > rssfeed_format", image))
    local format=ioload('rssfeed_format'):gsub("\n","")
    setvalue("rssfeed_format", format)
  end
\stopluacode

% Feedburner includes a GIF image at the end of feeds. When using pandoc to
% convert HTML to ConTeXt, that gets translated to \placefigure[...]{...}{...} 
% and we get a box with "undefined" in it. To fix that, we set:

\setupfloats[\c!width=\zeropoint, \c!height=\zeropoint]
\startmessages  english  library: floatblocks
12: 
\stopmessages

% Using asciimode is safer, but directly setting asciimode from
% a module does not work. 
\appendtoks
  \asciimode
\to\everystarttext

\protect
\stopmodule
